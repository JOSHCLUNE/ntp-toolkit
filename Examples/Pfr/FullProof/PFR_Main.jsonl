{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n","proof":":= by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp","declId":"PFR.Main.29_0.jPbc14P6cJZltrH","decl":"/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n","proof":":= by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp","declId":"PFR.Main.69_0.jPbc14P6cJZltrH","decl":"/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n","proof":":= by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩","declId":"PFR.Main.100_0.jPbc14P6cJZltrH","decl":"/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\n","proof":":= by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩","declId":"PFR.Main.112_0.jPbc14P6cJZltrH","decl":"lemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nlemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nvariable {G : Type*} [AddCommGroup G] [MeasurableSpace G]\n  [MeasurableSingletonClass G] {A : Set G} [Finite A] {K : ℝ} [Countable G]\n\n","proof":":= by\n  obtain ⟨A_pos, AA_pos, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  rcases independent_copies_two U₀meas U₀meas with ⟨Ω, mΩ, U, U', hP, hU, hU', UU'_indep, idU, idU'⟩\n  have Uunif : IsUniform A U := U₀unif.of_identDistrib idU.symm $ measurableSet_discrete _\n  have U'unif : IsUniform A U' := U₀unif.of_identDistrib idU'.symm $ measurableSet_discrete _\n  have IU : d[U # U'] ≤ log K := by\n    have I : H[U - U'] ≤ log (Nat.card (A - A)) := by\n      convert entropy_le_log_card_of_mem (A := (A-A).toFinite.toFinset) ?_ ?_ with x\n      . simp\n        exact Iff.rfl\n      . measurability\n      filter_upwards [Uunif.ae_mem, U'unif.ae_mem] with ω h1 h2\n      simp\n      exact Set.sub_mem_sub h1 h2\n    have J : log (Nat.card (A - A)) ≤ log K + log (Nat.card A) := by\n      apply (log_le_log AA_pos hA).trans (le_of_eq _)\n      rw [log_mul K_pos.ne' A_pos.ne']\n--    have : H[U + U'] = H[U - U'] := by congr; simp\n    rw [UU'_indep.rdist_eq hU hU', IsUniform.entropy_eq' Uunif hU, IsUniform.entropy_eq' U'unif hU']\n    linarith\n  rwa [idU.rdist_eq idU'] at IU","declId":"PFR.Main.126_0.jPbc14P6cJZltrH","decl":"/-- A uniform distribution on a set with doubling constant `K` has self Rusza distance\nat most `log K`. -/\ntheorem rdist_le_of_isUniform_of_card_add_le (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A)\n    {Ω : Type*} [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U₀ : Ω → G}\n    (U₀unif : IsUniform A U₀) (U₀meas : Measurable U₀) : d[U₀ # U₀] ≤ log K "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nlemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nvariable {G : Type*} [AddCommGroup G] [MeasurableSpace G]\n  [MeasurableSingletonClass G] {A : Set G} [Finite A] {K : ℝ} [Countable G]\n\n/-- A uniform distribution on a set with doubling constant `K` has self Rusza distance\nat most `log K`. -/\ntheorem rdist_le_of_isUniform_of_card_add_le (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A)\n    {Ω : Type*} [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U₀ : Ω → G}\n    (U₀unif : IsUniform A U₀) (U₀meas : Measurable U₀) : d[U₀ # U₀] ≤ log K := by\n  obtain ⟨A_pos, AA_pos, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  rcases independent_copies_two U₀meas U₀meas with ⟨Ω, mΩ, U, U', hP, hU, hU', UU'_indep, idU, idU'⟩\n  have Uunif : IsUniform A U := U₀unif.of_identDistrib idU.symm $ measurableSet_discrete _\n  have U'unif : IsUniform A U' := U₀unif.of_identDistrib idU'.symm $ measurableSet_discrete _\n  have IU : d[U # U'] ≤ log K := by\n    have I : H[U - U'] ≤ log (Nat.card (A - A)) := by\n      convert entropy_le_log_card_of_mem (A := (A-A).toFinite.toFinset) ?_ ?_ with x\n      . simp\n        exact Iff.rfl\n      . measurability\n      filter_upwards [Uunif.ae_mem, U'unif.ae_mem] with ω h1 h2\n      simp\n      exact Set.sub_mem_sub h1 h2\n    have J : log (Nat.card (A - A)) ≤ log K + log (Nat.card A) := by\n      apply (log_le_log AA_pos hA).trans (le_of_eq _)\n      rw [log_mul K_pos.ne' A_pos.ne']\n--    have : H[U + U'] = H[U - U'] := by congr; simp\n    rw [UU'_indep.rdist_eq hU hU', IsUniform.entropy_eq' Uunif hU, IsUniform.entropy_eq' U'unif hU']\n    linarith\n  rwa [idU.rdist_eq idU'] at IU\n\nvariable [ElementaryAddCommGroup G 2] [Fintype G]\n\n","proof":":= by\n  rw [← Set.image2_add, ← Set.image2_sub]\n  congr! 1 with a _ b _\n  show a + b = a - b\n  simp","declId":"PFR.Main.155_0.jPbc14P6cJZltrH","decl":"lemma sumset_eq_sub : A + A = A - A "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nlemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nvariable {G : Type*} [AddCommGroup G] [MeasurableSpace G]\n  [MeasurableSingletonClass G] {A : Set G} [Finite A] {K : ℝ} [Countable G]\n\n/-- A uniform distribution on a set with doubling constant `K` has self Rusza distance\nat most `log K`. -/\ntheorem rdist_le_of_isUniform_of_card_add_le (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A)\n    {Ω : Type*} [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U₀ : Ω → G}\n    (U₀unif : IsUniform A U₀) (U₀meas : Measurable U₀) : d[U₀ # U₀] ≤ log K := by\n  obtain ⟨A_pos, AA_pos, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  rcases independent_copies_two U₀meas U₀meas with ⟨Ω, mΩ, U, U', hP, hU, hU', UU'_indep, idU, idU'⟩\n  have Uunif : IsUniform A U := U₀unif.of_identDistrib idU.symm $ measurableSet_discrete _\n  have U'unif : IsUniform A U' := U₀unif.of_identDistrib idU'.symm $ measurableSet_discrete _\n  have IU : d[U # U'] ≤ log K := by\n    have I : H[U - U'] ≤ log (Nat.card (A - A)) := by\n      convert entropy_le_log_card_of_mem (A := (A-A).toFinite.toFinset) ?_ ?_ with x\n      . simp\n        exact Iff.rfl\n      . measurability\n      filter_upwards [Uunif.ae_mem, U'unif.ae_mem] with ω h1 h2\n      simp\n      exact Set.sub_mem_sub h1 h2\n    have J : log (Nat.card (A - A)) ≤ log K + log (Nat.card A) := by\n      apply (log_le_log AA_pos hA).trans (le_of_eq _)\n      rw [log_mul K_pos.ne' A_pos.ne']\n--    have : H[U + U'] = H[U - U'] := by congr; simp\n    rw [UU'_indep.rdist_eq hU hU', IsUniform.entropy_eq' Uunif hU, IsUniform.entropy_eq' U'unif hU']\n    linarith\n  rwa [idU.rdist_eq idU'] at IU\n\nvariable [ElementaryAddCommGroup G 2] [Fintype G]\n\nlemma sumset_eq_sub : A + A = A - A := by\n  rw [← Set.image2_add, ← Set.image2_sub]\n  congr! 1 with a _ b _\n  show a + b = a - b\n  simp\n\n","proof":":= by\n  classical\n  let _mG : MeasurableSpace G := ⊤\n  rw [sumset_eq_sub] at hA\n  have : MeasurableSingletonClass G := ⟨λ _ ↦ trivial⟩\n  obtain ⟨A_pos, -, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  let A' := A.toFinite.toFinset\n  have h₀A' : Finset.Nonempty A' := by\n    simp [Finset.Nonempty]\n    exact h₀A\n  have hAA' : A' = A := Finite.coe_toFinset (toFinite A)\n  rcases exists_isUniform_measureSpace A' h₀A' with ⟨Ω₀, mΩ₀, UA, hP₀, UAmeas, UAunif, -, -⟩\n  rw [hAA'] at UAunif\n  have : d[UA # UA] ≤ log K := rdist_le_of_isUniform_of_card_add_le h₀A hA UAunif UAmeas\n  rw [← sumset_eq_sub] at hA\n  let p : refPackage Ω₀ Ω₀ G := ⟨UA, UA, UAmeas, UAmeas, 1/9, (by norm_num), (by norm_num)⟩\n  -- entropic PFR gives a subgroup `H` which is close to `A` for the Rusza distance\n  rcases entropic_PFR_conjecture p (by norm_num) with ⟨H, Ω₁, mΩ₁, UH, hP₁, UHmeas, UHunif, hUH⟩\n  rcases independent_copies_two UAmeas UHmeas\n    with ⟨Ω, mΩ, VA, VH, hP, VAmeas, VHmeas, Vindep, idVA, idVH⟩\n  have VAunif : IsUniform A VA := UAunif.of_identDistrib idVA.symm $ measurableSet_discrete _\n  have VA'unif := VAunif\n  rw [← hAA'] at VA'unif\n  have VHunif : IsUniform H VH := UHunif.of_identDistrib idVH.symm $ measurableSet_discrete _\n  let H' := (H:Set G).toFinite.toFinset\n  have hHH' : H' = (H:Set G) := Finite.coe_toFinset (toFinite (H:Set G))\n  have VH'unif := VHunif\n  rw [← hHH'] at VH'unif\n\n  have : d[VA # VH] ≤ 11/2 * log K := by rw [idVA.rdist_eq idVH]; linarith\n  have H_pos : (0 : ℝ) < Nat.card (H : Set G) := by\n    have : 0 < Nat.card (H : Set G) := Nat.card_pos\n    positivity\n  have VA_ent : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n  have VH_ent : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n  have Icard : |log (Nat.card A) - log (Nat.card (H : Set G))| ≤ 11 * log K := by\n    rw [← VA_ent, ← VH_ent]\n    apply (diff_ent_le_rdist VAmeas VHmeas).trans\n    linarith\n  have IAH : Nat.card A ≤ K ^ 11 * Nat.card (H : Set G) := by\n    have : log (Nat.card A) ≤ log K * 11 + log (Nat.card (H : Set G)) := by\n      linarith [(le_abs_self _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log A_pos).symm\n    · rw [exp_add, exp_log H_pos, ← rpow_def_of_pos K_pos]\n  have IHA : Nat.card (H : Set G) ≤ K ^ 11 * Nat.card A := by\n    have : log (Nat.card (H : Set G)) ≤ log K * 11 + log (Nat.card A) := by\n      linarith [(neg_le_abs _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log H_pos).symm\n    · rw [exp_add, exp_log A_pos, ← rpow_def_of_pos K_pos]\n  -- entropic PFR shows that the entropy of `VA - VH` is small\n  have I : log K * (-11/2) + log (Nat.card A) * (-1/2) + log (Nat.card (H : Set G)) * (-1/2)\n      ≤ - H[VA - VH] := by\n    rw [Vindep.rdist_eq VAmeas VHmeas] at this\n    have : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n    have : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n    linarith\n  -- therefore, there exists a point `x₀` which is attained by `VA - VH` with a large probability\n  obtain ⟨x₀, h₀⟩ : ∃ x₀ : G, rexp (- H[VA - VH]) ≤ (ℙ : Measure Ω).real ((VA - VH) ⁻¹' {x₀}) :=\n    prob_ge_exp_neg_entropy' _ ((VAmeas.sub VHmeas).comp measurable_id')\n  -- massage the previous inequality to get that `A ∩ (H + {x₀})` is large\n  have J : K ^ (-11/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (1/2) ≤\n      Nat.card (A ∩ (H + {x₀}) : Set G) := by\n    rw [VA'unif.measureReal_preimage_sub VAmeas VH'unif VHmeas Vindep] at h₀\n    have := (Real.exp_monotone I).trans h₀\n    have hAA'_card : Nat.card A' = Nat.card A := congrArg Nat.card (congrArg Subtype hAA')\n    have hHH'_card : Nat.card H' = Nat.card (H : Set G) := congrArg Nat.card (congrArg Subtype hHH')\n    rw [hAA'_card, hHH'_card, le_div_iff] at this\n    convert this using 1\n    . rw [exp_add, exp_add, ← rpow_def_of_pos K_pos, ← rpow_def_of_pos A_pos, ← rpow_def_of_pos H_pos]\n      rpow_ring\n      norm_num\n    . rw [hAA', hHH']\n    positivity\n\n  have Hne : Set.Nonempty (A ∩ (H + {x₀} : Set G)) := by\n    by_contra h'\n    have : (0 : ℝ) < Nat.card (A ∩ (H + {x₀}) : Set G) := lt_of_lt_of_le (by positivity) J\n    simp only [Nat.card_eq_fintype_card, card_of_isEmpty, CharP.cast_eq_zero, lt_self_iff_false,\n      not_nonempty_iff_eq_empty.1 h'] at this\n  /- use Rusza covering lemma to cover `A` by few translates of `A ∩ (H + {x₀}) - A ∩ (H + {x₀})`\n  (which is contained in `H`). The number of translates is at most\n  `#(A + (A ∩ (H + {x₀}))) / #(A ∩ (H + {x₀}))`, where the numerator is controlled as this is\n  a subset of `A + A`, and the denominator is bounded below by the previous inequality`. -/\n  rcases Set.exists_subset_add_sub (toFinite A) (toFinite (A ∩ ((H + {x₀} : Set G)))) Hne with\n    ⟨u, hu, Au, -⟩\n  have Iu : Nat.card u ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := by\n    have : (0 : ℝ) ≤ Nat.card u := by simp\n    have Z1 := mul_le_mul_of_nonneg_left J this\n    have Z2 : (Nat.card u * Nat.card (A ∩ (H + {x₀}) : Set G) : ℝ)\n      ≤ Nat.card (A + A ∩ (↑H + {x₀})) := by norm_cast\n    have Z3 : (Nat.card (A + A ∩ (↑H + {x₀})) : ℝ) ≤ K * Nat.card A := by\n      apply le_trans _ hA\n      simp only [Nat.cast_le]\n      apply Nat.card_mono (toFinite _)\n      apply add_subset_add_left (inter_subset_left _ _)\n    have : 0 ≤ K ^ (11/2) * Nat.card A ^ (-1/2) * Nat.card (H : Set G) ^ (-1/2) := by positivity\n    have T := mul_le_mul_of_nonneg_left ((Z1.trans Z2).trans Z3) this\n    convert T using 1 <;> rpow_ring <;> norm_num\n  have A_subset_uH : A ⊆ u + H := by\n    rw [add_sub_assoc] at Au\n    refine Au.trans $ add_subset_add_left $\n      (sub_subset_sub (inter_subset_right ..) (inter_subset_right ..)).trans ?_\n    rw [add_sub_add_comm, singleton_sub_singleton, sub_self]\n    simp\n  exact ⟨H, u, Iu, IHA, IAH, A_subset_uH⟩","declId":"PFR.Main.161_0.jPbc14P6cJZltrH","decl":"/-- Auxiliary statement towards the polynomial Freiman-Ruzsa (PFR) conjecture: if $A$ is a subset of\nan elementary abelian 2-group of doubling constant at most $K$, then there exists a subgroup $H$\nsuch that $A$ can be covered by at most $K^{13/2} |A|^{1/2} / |H|^{1/2}$ cosets of $H$, and $H$ has\nthe same cardinality as $A$ up to a multiplicative factor $K^11$. -/\nlemma PFR_conjecture_aux (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    ∃ (H : AddSubgroup G) (c : Set G),\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2)\n      ∧ Nat.card H ≤ K ^ 11 * Nat.card A ∧ Nat.card A ≤ K ^ 11 * Nat.card H ∧ A ⊆ c + H "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nlemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nvariable {G : Type*} [AddCommGroup G] [MeasurableSpace G]\n  [MeasurableSingletonClass G] {A : Set G} [Finite A] {K : ℝ} [Countable G]\n\n/-- A uniform distribution on a set with doubling constant `K` has self Rusza distance\nat most `log K`. -/\ntheorem rdist_le_of_isUniform_of_card_add_le (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A)\n    {Ω : Type*} [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U₀ : Ω → G}\n    (U₀unif : IsUniform A U₀) (U₀meas : Measurable U₀) : d[U₀ # U₀] ≤ log K := by\n  obtain ⟨A_pos, AA_pos, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  rcases independent_copies_two U₀meas U₀meas with ⟨Ω, mΩ, U, U', hP, hU, hU', UU'_indep, idU, idU'⟩\n  have Uunif : IsUniform A U := U₀unif.of_identDistrib idU.symm $ measurableSet_discrete _\n  have U'unif : IsUniform A U' := U₀unif.of_identDistrib idU'.symm $ measurableSet_discrete _\n  have IU : d[U # U'] ≤ log K := by\n    have I : H[U - U'] ≤ log (Nat.card (A - A)) := by\n      convert entropy_le_log_card_of_mem (A := (A-A).toFinite.toFinset) ?_ ?_ with x\n      . simp\n        exact Iff.rfl\n      . measurability\n      filter_upwards [Uunif.ae_mem, U'unif.ae_mem] with ω h1 h2\n      simp\n      exact Set.sub_mem_sub h1 h2\n    have J : log (Nat.card (A - A)) ≤ log K + log (Nat.card A) := by\n      apply (log_le_log AA_pos hA).trans (le_of_eq _)\n      rw [log_mul K_pos.ne' A_pos.ne']\n--    have : H[U + U'] = H[U - U'] := by congr; simp\n    rw [UU'_indep.rdist_eq hU hU', IsUniform.entropy_eq' Uunif hU, IsUniform.entropy_eq' U'unif hU']\n    linarith\n  rwa [idU.rdist_eq idU'] at IU\n\nvariable [ElementaryAddCommGroup G 2] [Fintype G]\n\nlemma sumset_eq_sub : A + A = A - A := by\n  rw [← Set.image2_add, ← Set.image2_sub]\n  congr! 1 with a _ b _\n  show a + b = a - b\n  simp\n\n/-- Auxiliary statement towards the polynomial Freiman-Ruzsa (PFR) conjecture: if $A$ is a subset of\nan elementary abelian 2-group of doubling constant at most $K$, then there exists a subgroup $H$\nsuch that $A$ can be covered by at most $K^{13/2} |A|^{1/2} / |H|^{1/2}$ cosets of $H$, and $H$ has\nthe same cardinality as $A$ up to a multiplicative factor $K^11$. -/\nlemma PFR_conjecture_aux (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    ∃ (H : AddSubgroup G) (c : Set G),\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2)\n      ∧ Nat.card H ≤ K ^ 11 * Nat.card A ∧ Nat.card A ≤ K ^ 11 * Nat.card H ∧ A ⊆ c + H := by\n  classical\n  let _mG : MeasurableSpace G := ⊤\n  rw [sumset_eq_sub] at hA\n  have : MeasurableSingletonClass G := ⟨λ _ ↦ trivial⟩\n  obtain ⟨A_pos, -, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  let A' := A.toFinite.toFinset\n  have h₀A' : Finset.Nonempty A' := by\n    simp [Finset.Nonempty]\n    exact h₀A\n  have hAA' : A' = A := Finite.coe_toFinset (toFinite A)\n  rcases exists_isUniform_measureSpace A' h₀A' with ⟨Ω₀, mΩ₀, UA, hP₀, UAmeas, UAunif, -, -⟩\n  rw [hAA'] at UAunif\n  have : d[UA # UA] ≤ log K := rdist_le_of_isUniform_of_card_add_le h₀A hA UAunif UAmeas\n  rw [← sumset_eq_sub] at hA\n  let p : refPackage Ω₀ Ω₀ G := ⟨UA, UA, UAmeas, UAmeas, 1/9, (by norm_num), (by norm_num)⟩\n  -- entropic PFR gives a subgroup `H` which is close to `A` for the Rusza distance\n  rcases entropic_PFR_conjecture p (by norm_num) with ⟨H, Ω₁, mΩ₁, UH, hP₁, UHmeas, UHunif, hUH⟩\n  rcases independent_copies_two UAmeas UHmeas\n    with ⟨Ω, mΩ, VA, VH, hP, VAmeas, VHmeas, Vindep, idVA, idVH⟩\n  have VAunif : IsUniform A VA := UAunif.of_identDistrib idVA.symm $ measurableSet_discrete _\n  have VA'unif := VAunif\n  rw [← hAA'] at VA'unif\n  have VHunif : IsUniform H VH := UHunif.of_identDistrib idVH.symm $ measurableSet_discrete _\n  let H' := (H:Set G).toFinite.toFinset\n  have hHH' : H' = (H:Set G) := Finite.coe_toFinset (toFinite (H:Set G))\n  have VH'unif := VHunif\n  rw [← hHH'] at VH'unif\n\n  have : d[VA # VH] ≤ 11/2 * log K := by rw [idVA.rdist_eq idVH]; linarith\n  have H_pos : (0 : ℝ) < Nat.card (H : Set G) := by\n    have : 0 < Nat.card (H : Set G) := Nat.card_pos\n    positivity\n  have VA_ent : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n  have VH_ent : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n  have Icard : |log (Nat.card A) - log (Nat.card (H : Set G))| ≤ 11 * log K := by\n    rw [← VA_ent, ← VH_ent]\n    apply (diff_ent_le_rdist VAmeas VHmeas).trans\n    linarith\n  have IAH : Nat.card A ≤ K ^ 11 * Nat.card (H : Set G) := by\n    have : log (Nat.card A) ≤ log K * 11 + log (Nat.card (H : Set G)) := by\n      linarith [(le_abs_self _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log A_pos).symm\n    · rw [exp_add, exp_log H_pos, ← rpow_def_of_pos K_pos]\n  have IHA : Nat.card (H : Set G) ≤ K ^ 11 * Nat.card A := by\n    have : log (Nat.card (H : Set G)) ≤ log K * 11 + log (Nat.card A) := by\n      linarith [(neg_le_abs _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log H_pos).symm\n    · rw [exp_add, exp_log A_pos, ← rpow_def_of_pos K_pos]\n  -- entropic PFR shows that the entropy of `VA - VH` is small\n  have I : log K * (-11/2) + log (Nat.card A) * (-1/2) + log (Nat.card (H : Set G)) * (-1/2)\n      ≤ - H[VA - VH] := by\n    rw [Vindep.rdist_eq VAmeas VHmeas] at this\n    have : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n    have : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n    linarith\n  -- therefore, there exists a point `x₀` which is attained by `VA - VH` with a large probability\n  obtain ⟨x₀, h₀⟩ : ∃ x₀ : G, rexp (- H[VA - VH]) ≤ (ℙ : Measure Ω).real ((VA - VH) ⁻¹' {x₀}) :=\n    prob_ge_exp_neg_entropy' _ ((VAmeas.sub VHmeas).comp measurable_id')\n  -- massage the previous inequality to get that `A ∩ (H + {x₀})` is large\n  have J : K ^ (-11/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (1/2) ≤\n      Nat.card (A ∩ (H + {x₀}) : Set G) := by\n    rw [VA'unif.measureReal_preimage_sub VAmeas VH'unif VHmeas Vindep] at h₀\n    have := (Real.exp_monotone I).trans h₀\n    have hAA'_card : Nat.card A' = Nat.card A := congrArg Nat.card (congrArg Subtype hAA')\n    have hHH'_card : Nat.card H' = Nat.card (H : Set G) := congrArg Nat.card (congrArg Subtype hHH')\n    rw [hAA'_card, hHH'_card, le_div_iff] at this\n    convert this using 1\n    . rw [exp_add, exp_add, ← rpow_def_of_pos K_pos, ← rpow_def_of_pos A_pos, ← rpow_def_of_pos H_pos]\n      rpow_ring\n      norm_num\n    . rw [hAA', hHH']\n    positivity\n\n  have Hne : Set.Nonempty (A ∩ (H + {x₀} : Set G)) := by\n    by_contra h'\n    have : (0 : ℝ) < Nat.card (A ∩ (H + {x₀}) : Set G) := lt_of_lt_of_le (by positivity) J\n    simp only [Nat.card_eq_fintype_card, card_of_isEmpty, CharP.cast_eq_zero, lt_self_iff_false,\n      not_nonempty_iff_eq_empty.1 h'] at this\n  /- use Rusza covering lemma to cover `A` by few translates of `A ∩ (H + {x₀}) - A ∩ (H + {x₀})`\n  (which is contained in `H`). The number of translates is at most\n  `#(A + (A ∩ (H + {x₀}))) / #(A ∩ (H + {x₀}))`, where the numerator is controlled as this is\n  a subset of `A + A`, and the denominator is bounded below by the previous inequality`. -/\n  rcases Set.exists_subset_add_sub (toFinite A) (toFinite (A ∩ ((H + {x₀} : Set G)))) Hne with\n    ⟨u, hu, Au, -⟩\n  have Iu : Nat.card u ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := by\n    have : (0 : ℝ) ≤ Nat.card u := by simp\n    have Z1 := mul_le_mul_of_nonneg_left J this\n    have Z2 : (Nat.card u * Nat.card (A ∩ (H + {x₀}) : Set G) : ℝ)\n      ≤ Nat.card (A + A ∩ (↑H + {x₀})) := by norm_cast\n    have Z3 : (Nat.card (A + A ∩ (↑H + {x₀})) : ℝ) ≤ K * Nat.card A := by\n      apply le_trans _ hA\n      simp only [Nat.cast_le]\n      apply Nat.card_mono (toFinite _)\n      apply add_subset_add_left (inter_subset_left _ _)\n    have : 0 ≤ K ^ (11/2) * Nat.card A ^ (-1/2) * Nat.card (H : Set G) ^ (-1/2) := by positivity\n    have T := mul_le_mul_of_nonneg_left ((Z1.trans Z2).trans Z3) this\n    convert T using 1 <;> rpow_ring <;> norm_num\n  have A_subset_uH : A ⊆ u + H := by\n    rw [add_sub_assoc] at Au\n    refine Au.trans $ add_subset_add_left $\n      (sub_subset_sub (inter_subset_right ..) (inter_subset_right ..)).trans ?_\n    rw [add_sub_add_comm, singleton_sub_singleton, sub_self]\n    simp\n  exact ⟨H, u, Iu, IHA, IAH, A_subset_uH⟩\n\n\n","proof":":= by\n  obtain ⟨A_pos, -, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux' h₀A hA\n  -- consider the subgroup `H` given by Lemma `PFR_conjecture_aux`.\n  obtain ⟨H, c, hc, IHA, IAH, A_subs_cH⟩ : ∃ (H : AddSubgroup G) (c : Set G),\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2)\n      ∧ Nat.card (H : Set G) ≤ K ^ 11 * Nat.card A ∧ Nat.card A ≤ K ^ 11 * Nat.card (H : Set G)\n      ∧ A ⊆ c + H :=\n    PFR_conjecture_aux h₀A hA\n  have H_pos : (0 : ℝ) < Nat.card (H : Set G) := by\n    have : 0 < Nat.card (H : Set G) := Nat.card_pos; positivity\n  rcases le_or_lt (Nat.card (H : Set G)) (Nat.card A) with h|h\n  -- If `#H ≤ #A`, then `H` satisfies the conclusion of the theorem\n  · refine ⟨H, c, ?_, h, A_subs_cH⟩\n    calc\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := hc\n    _ ≤ K ^ (13/2) * (K ^ 11 * Nat.card (H : Set G)) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := by\n      gcongr\n    _ = K ^ 12 := by rpow_ring; norm_num\n    _ < 2 * K ^ 12 := by linarith [show 0 < K ^ 12 by positivity]\n  -- otherwise, we decompose `H` into cosets of one of its subgroups `H'`, chosen so that\n  -- `#A / 2 < #H' ≤ #A`. This `H'` satisfies the desired conclusion.\n  · obtain ⟨H', IH'A, IAH', H'H⟩ : ∃ H' : AddSubgroup G, Nat.card (H' : Set G) ≤ Nat.card A\n          ∧ Nat.card A < 2 * Nat.card (H' : Set G) ∧ H' ≤ H := by\n      have A_pos' : 0 < Nat.card A := mod_cast A_pos\n      exact ElementaryAddCommGroup.exists_subgroup_subset_card_le Nat.prime_two H h.le A_pos'.ne'\n    have : (Nat.card A / 2 : ℝ) < Nat.card (H' : Set G) := by\n      rw [div_lt_iff zero_lt_two, mul_comm]; norm_cast\n    have H'_pos : (0 : ℝ) < Nat.card (H' : Set G) := by\n      have : 0 < Nat.card (H' : Set G) := Nat.card_pos; positivity\n    obtain ⟨u, HH'u, hu⟩ := AddSubgroup.exists_left_transversal_of_le H'H\n    refine ⟨H', c + u, ?_, IH'A, by rwa [add_assoc, HH'u]⟩\n    calc\n    (Nat.card (c + u) : ℝ)\n      ≤ Nat.card c * Nat.card u := mod_cast card_add_le\n    _ ≤ (K ^ (13/2) * (Nat.card A) ^ (1 / 2) * (Nat.card (H : Set G) ^ (-1 / 2)))\n          * (Nat.card (H : Set G) / Nat.card (H' : Set G)) := by\n        gcongr\n        apply le_of_eq\n        rw [eq_div_iff H'_pos.ne']\n        norm_cast\n    _ < (K ^ (13/2) * (Nat.card A) ^ (1 / 2) * (Nat.card (H : Set G) ^ (-1 / 2)))\n          * (Nat.card (H : Set G) / (Nat.card A / 2)) := by\n        gcongr\n    _ = 2 * K ^ (13/2) * (Nat.card A) ^ (-1/2) * (Nat.card (H : Set G)) ^ (1/2) := by\n        have : (0 : ℝ) < Nat.card H := H_pos\n        field_simp\n        rpow_ring\n        norm_num\n    _ ≤ 2 * K ^ (13/2) * (Nat.card A) ^ (-1/2) * (K ^ 11 * Nat.card A) ^ (1/2) := by\n        gcongr\n    _ = 2 * K ^ 12 := by\n        rpow_ring\n        norm_num","declId":"PFR.Main.278_0.jPbc14P6cJZltrH","decl":"/-- The polynomial Freiman-Ruzsa (PFR) conjecture: if $A$ is a subset of an elementary abelian\n2-group of doubling constant at most $K$, then $A$ can be covered by at most $2K^{12}$ cosets of\na subgroup of cardinality at most $|A|$. -/\ntheorem PFR_conjecture (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n     ∃ (H : AddSubgroup G) (c : Set G),\n      Nat.card c < 2 * K ^ 12 ∧ Nat.card H ≤ Nat.card A ∧ A ⊆ c + H "}
{"srcUpToDecl":"import Mathlib.Combinatorics.Additive.RuzsaCovering\nimport Mathlib.GroupTheory.Complement\nimport Mathlib.GroupTheory.OrderOfElement\nimport PFR.Mathlib.GroupTheory.Subgroup.Pointwise\nimport PFR.ForMathlib.Entropy.RuzsaSetDist\nimport PFR.Tactic.RPowSimp\nimport PFR.TauFunctional\nimport PFR.EntropyPFR\n\n/- In this file the power notation will always mean the base and exponent are real numbers. -/\nlocal macro_rules | `($x ^ $y) => `(HPow.hPow ($x : ℝ) ($y : ℝ))\n\n/-!\n# Polynomial Freiman-Ruzsa conjecture\n\nHere we prove the polynomial Freiman-Ruzsa conjecture.\n-/\n\nopen ProbabilityTheory MeasureTheory Real Set Fintype Function\nopen scoped BigOperators Pointwise\n\nuniverse u\n\nnamespace ProbabilityTheory\nvariable {G Ω : Type*} [AddCommGroup G] [Fintype G]\n    [MeasurableSpace G] [MeasurableSingletonClass G] {A B : Finset G}\n    [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U V : Ω → G}\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V` with probability `# (A ∩ B) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub_zero (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {0})\n      = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n  have : (U - V) ⁻¹' {0} = ⋃ (g : G), (U ⁻¹' {g} ∩ V⁻¹' {g}) := by\n    ext ω; simp [sub_eq_zero, eq_comm]\n  rw [this, measureReal_iUnion_fintype _\n    (fun i ↦ (Umeas $ measurableSet_discrete _).inter $ Vmeas $ measurableSet_discrete _)]; swap\n  · intro g g' hgg'\n    apply Set.disjoint_iff_inter_eq_empty.2\n    ext a\n    simp (config := {contextual := True}) [hgg']\n  classical\n  let W : Finset G := A ∩ B\n  calc\n    ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p} ∩ V ⁻¹' {p})\n      = ∑ p, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply sum_congr _ _ (fun g ↦ ?_)\n        rw [hindep.measureReal_inter_preimage_eq_mul (measurableSet_discrete _) $\n          measurableSet_discrete _]\n    _ = ∑ p in W, (ℙ : Measure Ω).real (U ⁻¹' {p}) * (ℙ : Measure Ω).real (V ⁻¹' {p}) := by\n        apply (Finset.sum_subset W.subset_univ _).symm\n        intro i _ hi\n        replace hi : i ∉ A ∨ i ∉ B := by simp at hi; tauto\n        rcases hi with h'i|h'i\n        · simp [Uunif.measureReal_preimage_of_nmem h'i]\n        · simp [Vunif.measureReal_preimage_of_nmem h'i]\n    _ = ∑ p in W, (1 / Nat.card A : ℝ) * (1 / Nat.card B) := by\n        apply Finset.sum_congr rfl (fun i hi ↦ ?_)\n        replace hi : i ∈ A ∧ i ∈ B := by simpa using hi\n        rw [Uunif.measureReal_preimage_of_mem (by trivial) hi.1,\n            Vunif.measureReal_preimage_of_mem (by trivial) hi.2]\n    _ = (W.card : ℝ) / (Nat.card A * Nat.card B) := by simp [div_eq_inv_mul]; ring\n    _ = Nat.card (A ∩ B : Set G) / (Nat.card A * Nat.card B) := by\n        congr\n        rw [← Finset.coe_inter, Nat.card_eq_fintype_card, Fintype.card_ofFinset]\n        simp\n\n/-- Given two independent random variables `U` and `V` uniformly distributed respectively on `A`\nand `B`, then `U = V + x` with probability `# (A ∩ (B + x)) / #A ⬝ #B`. -/\nlemma IsUniform.measureReal_preimage_sub (Uunif : IsUniform A U) (Umeas : Measurable U)\n    (Vunif : IsUniform B V) (Vmeas : Measurable V) (hindep : IndepFun U V) (x : G) :\n    (ℙ : Measure Ω).real ((U - V) ⁻¹' {x})\n      = Nat.card (A ∩ (B + {x}) : Set G) / (Nat.card A * Nat.card B) := by\n  classical\n  let W := fun ω ↦ V ω + x\n  have Wunif : IsUniform (B + {x} : Set G) W := by\n    convert Vunif.comp (add_left_injective x)\n    simp\n  have Wmeas : Measurable W := Vmeas.add_const _\n  have UWindep : IndepFun U W := by\n    have : Measurable (fun g ↦ g + x) := measurable_add_const x\n    exact hindep.comp measurable_id this\n  have : (U - V) ⁻¹' {x} = (U - W) ⁻¹' {0} := by\n    ext ω\n    simp only [mem_preimage, Pi.add_apply, mem_singleton_iff, Pi.sub_apply, ← sub_eq_zero (b := x)]\n    abel_nf\n  have h : (B:Set G)+{x} = (B+{x}:Finset G) := by simp\n  rw [h] at Wunif\n  rw [this, Uunif.measureReal_preimage_sub_zero Umeas Wunif Wmeas UWindep]\n  congr 3\n  . rw [add_singleton]; simp\n  convert Finset.card_vadd_finset (AddOpposite.op x) B\n  . simp\n  simp\n\nend ProbabilityTheory\n\n\n/-- Record positivity results that are useful in the proof of PFR. -/\nlemma PFR_conjecture_pos_aux {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A - A) := by\n    have : Nonempty (A - A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.sub h₀A h₀A)\n    have : Finite (A - A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nlemma PFR_conjecture_pos_aux' {G : Type*} [AddCommGroup G] {A : Set G} [Finite A] {K : ℝ} (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K := by\n  have card_AA_pos : (0 : ℝ) < Nat.card (A + A) := by\n    have : Nonempty (A + A) := Set.nonempty_coe_sort.mpr (Set.Nonempty.add h₀A h₀A)\n    have : Finite (A + A) := finite_coe_iff.mpr (Finite.image2 _ (Set.toFinite A) (Set.toFinite A))\n    simp [Nat.cast_pos, Nat.card_pos_iff]\n  have KA_pos : 0 < K ∧ (0 : ℝ) < Nat.card A := by\n    have I : ¬ ((Nat.card A : ℝ) < 0) := by simp\n    simpa [Nat.cast_pos, I, and_false, or_false] using mul_pos_iff.1 (card_AA_pos.trans_le hA)\n  exact ⟨KA_pos.2, card_AA_pos, KA_pos.1⟩\n\nvariable {G : Type*} [AddCommGroup G] [MeasurableSpace G]\n  [MeasurableSingletonClass G] {A : Set G} [Finite A] {K : ℝ} [Countable G]\n\n/-- A uniform distribution on a set with doubling constant `K` has self Rusza distance\nat most `log K`. -/\ntheorem rdist_le_of_isUniform_of_card_add_le (h₀A : A.Nonempty) (hA : Nat.card (A - A) ≤ K * Nat.card A)\n    {Ω : Type*} [MeasureSpace Ω] [IsProbabilityMeasure (ℙ : Measure Ω)] {U₀ : Ω → G}\n    (U₀unif : IsUniform A U₀) (U₀meas : Measurable U₀) : d[U₀ # U₀] ≤ log K := by\n  obtain ⟨A_pos, AA_pos, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  rcases independent_copies_two U₀meas U₀meas with ⟨Ω, mΩ, U, U', hP, hU, hU', UU'_indep, idU, idU'⟩\n  have Uunif : IsUniform A U := U₀unif.of_identDistrib idU.symm $ measurableSet_discrete _\n  have U'unif : IsUniform A U' := U₀unif.of_identDistrib idU'.symm $ measurableSet_discrete _\n  have IU : d[U # U'] ≤ log K := by\n    have I : H[U - U'] ≤ log (Nat.card (A - A)) := by\n      convert entropy_le_log_card_of_mem (A := (A-A).toFinite.toFinset) ?_ ?_ with x\n      . simp\n        exact Iff.rfl\n      . measurability\n      filter_upwards [Uunif.ae_mem, U'unif.ae_mem] with ω h1 h2\n      simp\n      exact Set.sub_mem_sub h1 h2\n    have J : log (Nat.card (A - A)) ≤ log K + log (Nat.card A) := by\n      apply (log_le_log AA_pos hA).trans (le_of_eq _)\n      rw [log_mul K_pos.ne' A_pos.ne']\n--    have : H[U + U'] = H[U - U'] := by congr; simp\n    rw [UU'_indep.rdist_eq hU hU', IsUniform.entropy_eq' Uunif hU, IsUniform.entropy_eq' U'unif hU']\n    linarith\n  rwa [idU.rdist_eq idU'] at IU\n\nvariable [ElementaryAddCommGroup G 2] [Fintype G]\n\nlemma sumset_eq_sub : A + A = A - A := by\n  rw [← Set.image2_add, ← Set.image2_sub]\n  congr! 1 with a _ b _\n  show a + b = a - b\n  simp\n\n/-- Auxiliary statement towards the polynomial Freiman-Ruzsa (PFR) conjecture: if $A$ is a subset of\nan elementary abelian 2-group of doubling constant at most $K$, then there exists a subgroup $H$\nsuch that $A$ can be covered by at most $K^{13/2} |A|^{1/2} / |H|^{1/2}$ cosets of $H$, and $H$ has\nthe same cardinality as $A$ up to a multiplicative factor $K^11$. -/\nlemma PFR_conjecture_aux (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    ∃ (H : AddSubgroup G) (c : Set G),\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2)\n      ∧ Nat.card H ≤ K ^ 11 * Nat.card A ∧ Nat.card A ≤ K ^ 11 * Nat.card H ∧ A ⊆ c + H := by\n  classical\n  let _mG : MeasurableSpace G := ⊤\n  rw [sumset_eq_sub] at hA\n  have : MeasurableSingletonClass G := ⟨λ _ ↦ trivial⟩\n  obtain ⟨A_pos, -, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A - A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux h₀A hA\n  let A' := A.toFinite.toFinset\n  have h₀A' : Finset.Nonempty A' := by\n    simp [Finset.Nonempty]\n    exact h₀A\n  have hAA' : A' = A := Finite.coe_toFinset (toFinite A)\n  rcases exists_isUniform_measureSpace A' h₀A' with ⟨Ω₀, mΩ₀, UA, hP₀, UAmeas, UAunif, -, -⟩\n  rw [hAA'] at UAunif\n  have : d[UA # UA] ≤ log K := rdist_le_of_isUniform_of_card_add_le h₀A hA UAunif UAmeas\n  rw [← sumset_eq_sub] at hA\n  let p : refPackage Ω₀ Ω₀ G := ⟨UA, UA, UAmeas, UAmeas, 1/9, (by norm_num), (by norm_num)⟩\n  -- entropic PFR gives a subgroup `H` which is close to `A` for the Rusza distance\n  rcases entropic_PFR_conjecture p (by norm_num) with ⟨H, Ω₁, mΩ₁, UH, hP₁, UHmeas, UHunif, hUH⟩\n  rcases independent_copies_two UAmeas UHmeas\n    with ⟨Ω, mΩ, VA, VH, hP, VAmeas, VHmeas, Vindep, idVA, idVH⟩\n  have VAunif : IsUniform A VA := UAunif.of_identDistrib idVA.symm $ measurableSet_discrete _\n  have VA'unif := VAunif\n  rw [← hAA'] at VA'unif\n  have VHunif : IsUniform H VH := UHunif.of_identDistrib idVH.symm $ measurableSet_discrete _\n  let H' := (H:Set G).toFinite.toFinset\n  have hHH' : H' = (H:Set G) := Finite.coe_toFinset (toFinite (H:Set G))\n  have VH'unif := VHunif\n  rw [← hHH'] at VH'unif\n\n  have : d[VA # VH] ≤ 11/2 * log K := by rw [idVA.rdist_eq idVH]; linarith\n  have H_pos : (0 : ℝ) < Nat.card (H : Set G) := by\n    have : 0 < Nat.card (H : Set G) := Nat.card_pos\n    positivity\n  have VA_ent : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n  have VH_ent : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n  have Icard : |log (Nat.card A) - log (Nat.card (H : Set G))| ≤ 11 * log K := by\n    rw [← VA_ent, ← VH_ent]\n    apply (diff_ent_le_rdist VAmeas VHmeas).trans\n    linarith\n  have IAH : Nat.card A ≤ K ^ 11 * Nat.card (H : Set G) := by\n    have : log (Nat.card A) ≤ log K * 11 + log (Nat.card (H : Set G)) := by\n      linarith [(le_abs_self _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log A_pos).symm\n    · rw [exp_add, exp_log H_pos, ← rpow_def_of_pos K_pos]\n  have IHA : Nat.card (H : Set G) ≤ K ^ 11 * Nat.card A := by\n    have : log (Nat.card (H : Set G)) ≤ log K * 11 + log (Nat.card A) := by\n      linarith [(neg_le_abs _).trans Icard]\n    convert exp_monotone this using 1\n    · exact (exp_log H_pos).symm\n    · rw [exp_add, exp_log A_pos, ← rpow_def_of_pos K_pos]\n  -- entropic PFR shows that the entropy of `VA - VH` is small\n  have I : log K * (-11/2) + log (Nat.card A) * (-1/2) + log (Nat.card (H : Set G)) * (-1/2)\n      ≤ - H[VA - VH] := by\n    rw [Vindep.rdist_eq VAmeas VHmeas] at this\n    have : H[VA] = log (Nat.card A) := IsUniform.entropy_eq' VAunif VAmeas\n    have : H[VH] = log (Nat.card (H : Set G)) := IsUniform.entropy_eq' VHunif VHmeas\n    linarith\n  -- therefore, there exists a point `x₀` which is attained by `VA - VH` with a large probability\n  obtain ⟨x₀, h₀⟩ : ∃ x₀ : G, rexp (- H[VA - VH]) ≤ (ℙ : Measure Ω).real ((VA - VH) ⁻¹' {x₀}) :=\n    prob_ge_exp_neg_entropy' _ ((VAmeas.sub VHmeas).comp measurable_id')\n  -- massage the previous inequality to get that `A ∩ (H + {x₀})` is large\n  have J : K ^ (-11/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (1/2) ≤\n      Nat.card (A ∩ (H + {x₀}) : Set G) := by\n    rw [VA'unif.measureReal_preimage_sub VAmeas VH'unif VHmeas Vindep] at h₀\n    have := (Real.exp_monotone I).trans h₀\n    have hAA'_card : Nat.card A' = Nat.card A := congrArg Nat.card (congrArg Subtype hAA')\n    have hHH'_card : Nat.card H' = Nat.card (H : Set G) := congrArg Nat.card (congrArg Subtype hHH')\n    rw [hAA'_card, hHH'_card, le_div_iff] at this\n    convert this using 1\n    . rw [exp_add, exp_add, ← rpow_def_of_pos K_pos, ← rpow_def_of_pos A_pos, ← rpow_def_of_pos H_pos]\n      rpow_ring\n      norm_num\n    . rw [hAA', hHH']\n    positivity\n\n  have Hne : Set.Nonempty (A ∩ (H + {x₀} : Set G)) := by\n    by_contra h'\n    have : (0 : ℝ) < Nat.card (A ∩ (H + {x₀}) : Set G) := lt_of_lt_of_le (by positivity) J\n    simp only [Nat.card_eq_fintype_card, card_of_isEmpty, CharP.cast_eq_zero, lt_self_iff_false,\n      not_nonempty_iff_eq_empty.1 h'] at this\n  /- use Rusza covering lemma to cover `A` by few translates of `A ∩ (H + {x₀}) - A ∩ (H + {x₀})`\n  (which is contained in `H`). The number of translates is at most\n  `#(A + (A ∩ (H + {x₀}))) / #(A ∩ (H + {x₀}))`, where the numerator is controlled as this is\n  a subset of `A + A`, and the denominator is bounded below by the previous inequality`. -/\n  rcases Set.exists_subset_add_sub (toFinite A) (toFinite (A ∩ ((H + {x₀} : Set G)))) Hne with\n    ⟨u, hu, Au, -⟩\n  have Iu : Nat.card u ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := by\n    have : (0 : ℝ) ≤ Nat.card u := by simp\n    have Z1 := mul_le_mul_of_nonneg_left J this\n    have Z2 : (Nat.card u * Nat.card (A ∩ (H + {x₀}) : Set G) : ℝ)\n      ≤ Nat.card (A + A ∩ (↑H + {x₀})) := by norm_cast\n    have Z3 : (Nat.card (A + A ∩ (↑H + {x₀})) : ℝ) ≤ K * Nat.card A := by\n      apply le_trans _ hA\n      simp only [Nat.cast_le]\n      apply Nat.card_mono (toFinite _)\n      apply add_subset_add_left (inter_subset_left _ _)\n    have : 0 ≤ K ^ (11/2) * Nat.card A ^ (-1/2) * Nat.card (H : Set G) ^ (-1/2) := by positivity\n    have T := mul_le_mul_of_nonneg_left ((Z1.trans Z2).trans Z3) this\n    convert T using 1 <;> rpow_ring <;> norm_num\n  have A_subset_uH : A ⊆ u + H := by\n    rw [add_sub_assoc] at Au\n    refine Au.trans $ add_subset_add_left $\n      (sub_subset_sub (inter_subset_right ..) (inter_subset_right ..)).trans ?_\n    rw [add_sub_add_comm, singleton_sub_singleton, sub_self]\n    simp\n  exact ⟨H, u, Iu, IHA, IAH, A_subset_uH⟩\n\n\n/-- The polynomial Freiman-Ruzsa (PFR) conjecture: if $A$ is a subset of an elementary abelian\n2-group of doubling constant at most $K$, then $A$ can be covered by at most $2K^{12}$ cosets of\na subgroup of cardinality at most $|A|$. -/\ntheorem PFR_conjecture (h₀A : A.Nonempty) (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n     ∃ (H : AddSubgroup G) (c : Set G),\n      Nat.card c < 2 * K ^ 12 ∧ Nat.card H ≤ Nat.card A ∧ A ⊆ c + H := by\n  obtain ⟨A_pos, -, K_pos⟩ : (0 : ℝ) < Nat.card A ∧ (0 : ℝ) < Nat.card (A + A) ∧ 0 < K :=\n    PFR_conjecture_pos_aux' h₀A hA\n  -- consider the subgroup `H` given by Lemma `PFR_conjecture_aux`.\n  obtain ⟨H, c, hc, IHA, IAH, A_subs_cH⟩ : ∃ (H : AddSubgroup G) (c : Set G),\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2)\n      ∧ Nat.card (H : Set G) ≤ K ^ 11 * Nat.card A ∧ Nat.card A ≤ K ^ 11 * Nat.card (H : Set G)\n      ∧ A ⊆ c + H :=\n    PFR_conjecture_aux h₀A hA\n  have H_pos : (0 : ℝ) < Nat.card (H : Set G) := by\n    have : 0 < Nat.card (H : Set G) := Nat.card_pos; positivity\n  rcases le_or_lt (Nat.card (H : Set G)) (Nat.card A) with h|h\n  -- If `#H ≤ #A`, then `H` satisfies the conclusion of the theorem\n  · refine ⟨H, c, ?_, h, A_subs_cH⟩\n    calc\n    Nat.card c ≤ K ^ (13/2) * (Nat.card A) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := hc\n    _ ≤ K ^ (13/2) * (K ^ 11 * Nat.card (H : Set G)) ^ (1/2) * (Nat.card (H : Set G)) ^ (-1/2) := by\n      gcongr\n    _ = K ^ 12 := by rpow_ring; norm_num\n    _ < 2 * K ^ 12 := by linarith [show 0 < K ^ 12 by positivity]\n  -- otherwise, we decompose `H` into cosets of one of its subgroups `H'`, chosen so that\n  -- `#A / 2 < #H' ≤ #A`. This `H'` satisfies the desired conclusion.\n  · obtain ⟨H', IH'A, IAH', H'H⟩ : ∃ H' : AddSubgroup G, Nat.card (H' : Set G) ≤ Nat.card A\n          ∧ Nat.card A < 2 * Nat.card (H' : Set G) ∧ H' ≤ H := by\n      have A_pos' : 0 < Nat.card A := mod_cast A_pos\n      exact ElementaryAddCommGroup.exists_subgroup_subset_card_le Nat.prime_two H h.le A_pos'.ne'\n    have : (Nat.card A / 2 : ℝ) < Nat.card (H' : Set G) := by\n      rw [div_lt_iff zero_lt_two, mul_comm]; norm_cast\n    have H'_pos : (0 : ℝ) < Nat.card (H' : Set G) := by\n      have : 0 < Nat.card (H' : Set G) := Nat.card_pos; positivity\n    obtain ⟨u, HH'u, hu⟩ := AddSubgroup.exists_left_transversal_of_le H'H\n    refine ⟨H', c + u, ?_, IH'A, by rwa [add_assoc, HH'u]⟩\n    calc\n    (Nat.card (c + u) : ℝ)\n      ≤ Nat.card c * Nat.card u := mod_cast card_add_le\n    _ ≤ (K ^ (13/2) * (Nat.card A) ^ (1 / 2) * (Nat.card (H : Set G) ^ (-1 / 2)))\n          * (Nat.card (H : Set G) / Nat.card (H' : Set G)) := by\n        gcongr\n        apply le_of_eq\n        rw [eq_div_iff H'_pos.ne']\n        norm_cast\n    _ < (K ^ (13/2) * (Nat.card A) ^ (1 / 2) * (Nat.card (H : Set G) ^ (-1 / 2)))\n          * (Nat.card (H : Set G) / (Nat.card A / 2)) := by\n        gcongr\n    _ = 2 * K ^ (13/2) * (Nat.card A) ^ (-1/2) * (Nat.card (H : Set G)) ^ (1/2) := by\n        have : (0 : ℝ) < Nat.card H := H_pos\n        field_simp\n        rpow_ring\n        norm_num\n    _ ≤ 2 * K ^ (13/2) * (Nat.card A) ^ (-1/2) * (K ^ 11 * Nat.card A) ^ (1/2) := by\n        gcongr\n    _ = 2 * K ^ 12 := by\n        rpow_ring\n        norm_num\n\n","proof":":= by\n  let G' := AddSubgroup.closure A\n  let G'fin : Fintype G' := by\n    exact Finite.fintype (ElementaryAddCommGroup.finite_closure Afin)\n  have G'Elem : ElementaryAddCommGroup G' 2 := ElementaryAddCommGroup.subgroup _\n  let ι : G'→+ G := G'.subtype\n  have ι_inj : Injective ι := AddSubgroup.subtype_injective G'\n  let A' : Set G' := ι ⁻¹' A\n  have A_rg : A ⊆ range ι := by simpa using AddSubgroup.subset_closure\n  have cardA' : Nat.card A' = Nat.card A := Nat.card_preimage_of_injective ι_inj A_rg\n  have hA' : Nat.card (A' + A') ≤ K * Nat.card A' := by\n    rwa [cardA', ← preimage_add _ ι_inj A_rg A_rg,\n         Nat.card_preimage_of_injective ι_inj (add_subset_range _ A_rg A_rg)]\n  rcases PFR_conjecture (h₀A.preimage' A_rg) hA' with ⟨H', c', hc', hH', hH'₂⟩\n  refine ⟨AddSubgroup.map ι H', ι '' c', toFinite _, toFinite (ι '' H'), ?_, ?_, fun x hx ↦ ?_⟩\n  · rwa [Nat.card_image_of_injective ι_inj]\n  · erw [Nat.card_image_of_injective ι_inj, ← cardA']\n    exact hH'\n  · erw [← image_add]\n    exact ⟨⟨x, AddSubgroup.subset_closure hx⟩, hH'₂ hx, rfl⟩","declId":"PFR.Main.338_0.jPbc14P6cJZltrH","decl":"/-- Corollary of `PFR_conjecture` in which the ambient group is not required to be finite (but) then\n$H$ and $c$ are finite. -/\ntheorem PFR_conjecture' {G : Type*} [AddCommGroup G] [ElementaryAddCommGroup G 2]\n    {A : Set G} {K : ℝ} (h₀A : A.Nonempty) (Afin : A.Finite)\n    (hA : Nat.card (A + A) ≤ K * Nat.card A) :\n    ∃ (H : AddSubgroup G) (c : Set G), c.Finite ∧ (H : Set G).Finite ∧\n      Nat.card c < 2 * K ^ 12 ∧ Nat.card H ≤ Nat.card A ∧ A ⊆ c + H "}
